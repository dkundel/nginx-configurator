# =============================
# AUTOGENERATED
# DO NOT MODIFY MANUALLY
# CHANGES WILL BE OVERRIDEN
# RATHER ADD SNIPPETS
# =============================

<%_ hosts.forEach(function(host) { _%>
server {
  listen <%= host.ssl ? '443 ssl' : '80' _%> <%= host.http2 ? ' http2' : '' _%>;
  listen [::]:<%= host.ssl ? '443 ssl' : '80' _%> <%= host.http2 ? ' http2' : '' _%>;
  <%_ if (host.ssl && host.noForcedSsl) { _%>
  listen 80;
  listen [::]:80;
  <%_ } _%>
  <%_ if (host.root) { _%> 
  root <%= host.root %>;
  <%_ } _%>
  index index.html index.htm;
  # Make site accessible from http://localhost/
  server_name <%= Array.isArray(host.serverNames) ? host.serverNames.join(' ') : 'localhost' _%>;
  <%_ if (host.ssl && host.sslEnabled) { _%>
  include snippets/ssl-<%= host.ssl _%>.conf;
  include snippets/ssl-params.conf;
  <%_ } _%>
  <%_ if (Array.isArray(host.snippets)) { _%>
  <%_ host.snippets.forEach(function(snipp) { _%>
  include snippets/<%= snipp _%>;
  <%_ }); _%>
  <%_ } _%>
  <%_ if (host.root) { _%>
  location / {
    try_files $uri.html $uri $uri/ =404;
  }
  <%_ } _%>
  <%_ if (host.proxy) { _%>
  location / {
    proxy_pass http://127.0.0.1:<%= host.proxy _%>;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
  }
  <%_ } _%>
  <%_ if (Array.isArray(host.locations)) { _%>
  <%_ host.locations.forEach(function(loc) { _%>
  location <%= loc.path %> {
    try_files $uri $uri/ =404;
    <%_ if (loc.root) { _%>
    root <%= loc.root _%>;
    <%_ } _%>
    <%_ if (host.naxi) { _%>
    include /etc/nginx/naxsi.rules;
    <%_ } _%>
    <%_ if (typeof loc.auth === 'string') { _%>
    auth_basic "Restricted Content";
    auth_basic_user_file <%= loc.auth %>;
    <%_ } _%>
  }
  <%_ }); _%>
  <%_ } _%>
    <%_ if (host.ssl) { _%>
  location ~ /.well-known {
    allow all;
    <%= ssl[host.ssl].webroot ? 'root ' + ssl[host.ssl].webroot : '' %>;
  }
  <%_ } _%>
}

<%_ if (host.ssl && !host.noForcedSsl) { _%>
server {
  listen 80;
  listen [::]:80;
  server_name <%= Array.isArray(host.serverNames) ? host.serverNames.join(' ') : 'localhost' _%>;
  # Redirect all HTTP requests to HTTPS with a 301 Moved Permanently response.
  return 301 https://$host$request_uri;
}

<%_ } _%>
<%_ }); _%>
